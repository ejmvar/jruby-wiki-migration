{"href":"https://kenai.com/api/projects/jruby/features/wiki/pages/JRubyOnRailsWithGlassfishGem/revisions/9.json","name":"JRubyOnRailsWithGlassfishGem","number":9,"page_href":"https://kenai.com/api/projects/jruby/features/wiki/pages/JRubyOnRailsWithGlassfishGem.json","person":"pfussell","description":"Added link at top to JRuby on Rails page","text":"[[Home|&raquo; JRuby Project Wiki Home Page]] &nbsp; &nbsp; [[JRubyOnRails#Glassfish_v3_Deployment|&raquo; JRuby on Rails: Glassfish V3 Deployment]]\n<h1>JRuby on Rails With Glassfish Gem</h1>\nThis page discusses how to use the Glassfish Gem with JRuby 1.3.1 or later to get Glassfish working with a JRuby on Rails application.<br/><br/>\n\n__TOC__\n\n==JRuby 1.3.1 and Glassfish Gem Setup==\nInstall [http://jruby.org/download JRuby] in <tt>/opt/jruby-1.3.1</tt> and symlink <tt>/opt/jruby</tt> to <tt>/opt/jruby-1.3.1</tt> for future convenience.\n\n # <tt>cd /opt && curl -O <nowiki>http://url.to/jruby-1.3.1.tar.gz</nowiki></tt>\n # <tt>tar xzvf jruby-1.3.1.tar.gz</tt>\n # <tt>ln -s jruby-1.3.1 jruby</tt>\n\nTo install the Glassfish gem (by Vivek Pandey):\n $ gem i glassfish\n\nIf you install Glassfish as a non-root user, you should for your own convenience add <tt>~/.gem/jruby/1.8/bin</tt> to your PATH. You should also have JRuby in your PATH. \n\nIf you install Glassfish as root, the Glassfish <tt>bin</tt> will be installed by default in the JRuby <tt>bin</tt> directory.\n\nI recommend putting something like this in your <tt>.bashrc</tt> so it's set whenever you log in:\n $ export JRUBY_HOME=/opt/jruby \n $ export PATH=~/.gem/jruby/1.8/bin:$JRUBY_HOME/bin:$PATH\n\n== Configure Your Glassfish Instance for Your Rails Application ==\n $ cd /path/to/rails-app\n $ jruby -S gfrake config   # Sets up initial config/glassfish.yml\n\nNow edit <tt>config/glassfish.yml</tt> to configure the instance to your liking. For instance:\n\n<pre name=\"xml\">\n environment: production\n http:\n    port: 3000\n    contextroot: /\n\n log:\n    # Logging level. Log level 0 to 7. 0:OFF, 1:SEVERE, 2:WARNING, 3:INFO (default), 4:FINE, 5:FINER, 6:FINEST, 7:ALL.\n    log-level: 2\n\n jruby-runtime-pool:\n    initial: 1\n    min: 1\n    max: 1\n\n daemon:\n    enable: true\n    pid: tmp/pids/glassfish-production.pid\n    jvm-options: -server -Xmx2500m -Xms64m -XX:PermSize=256m -XX:MaxPermSize=256m -XX:NewRatio=2 -XX:+DisableExplicitGC -Dhk2.file.directory.changeIntervalTimer=6000\n</pre>\n\n===Running the Appserver===\nRunning your Glassfish application server is very simple:\n $ jruby -S glassfish \n\n===Stopping the Appserver===\nThe application is started with the Akuma wrapper, which by default exits when passed a SIGINT (2) (default value of <tt>kill</tt>). For instance:\n $ kill `cat tmp/pids/glassfish-production.pid`  \n\n==Integrating Glassfish Gem with Solaris Management Facility (SMF)==\nIn Solaris 10 and OpenSolaris, you get an excellent service management facility called SMF that you can easily configure to run your applications on startup (and much more). It can be compared with Linux's <tt>init.rd / rc.d</tt>, but is much more powerful. \n\nImporting an application into SMF is not so trivial for first time users, so here is a brief description. For more informaiton, see [http://www.sun.com/bigadmin/content/selfheal/smf-quickstart.jsp Solaris Service Management Facility - Quickstart Guide].\n\n===Define a Manifest===\nFirst off you need to define a manifest. This is done with a simple XML file. \n\nUnderneath, you will find a manifest with support of two instances or rails applications. Modify these to your liking. I usually prefer to run applications with a non-root user. I haven't included Access Control Lists (ACLs) to minimize the complexity in the example. \n\nI usually recommend placing web applications such as Rails somewhere under <tt>/var</tt>. In the example I use <tt>/var/apps</tt>. I also use directories like <tt>/var/rails</tt> and so on, but you can put them in your home directory if you prefer.\n\n<pre name=\"xml\">\n<?xml version='1.0'?>\n<!DOCTYPE service_bundle SYSTEM '/usr/share/lib/xml/dtd/service_bundle.dtd.1'>\n<service_bundle type='manifest' name='glassfish-gem'>\n  <service name='network/glassfish-gem' type='service' version='0'>\n    <dependency name='fs' grouping='require_all' restart_on='none' type='service'>\n      <service_fmri value='svc:/system/filesystem/local'/>\n    </dependency>\n    <dependency name='net' grouping='require_all' restart_on='none' type='service'>\n      <service_fmri value='svc:/network/loopback'/>\n    </dependency>\n    <dependent name='glassfish-gem_multi-user' restart_on='none' grouping='optional_all'>\n      <service_fmri value='svc:/milestone/multi-user'/>\n    </dependent>\n    <exec_method name='start' type='method' exec='/opt/jruby/bin/glassfish' timeout_seconds='60' />\n    <exec_method name='stop' type='method' exec=':kill' timeout_seconds='60' />\n    <!-- INSTANCES -->        \n    <instance name='my-railsapp_production' enabled='false'>\n      <method_context working_directory='/var/apps/my-railsapp/development/my-railsapp'>\n        <method_credential user='railsuser' group='daemon' />\n        <method_environment>\n          <envvar name=\"PATH\" value=\"/opt/jruby/bin:/usr/bin:/bin\" />\n        </method_environment>\n      </method_context>\n    </instance>\n    <instance name='MYRAILSAPP_ENVIRONMENT' enabled='false'>\n      <method_context working_directory='/FULL/PATH/TO/MY/RAILS/APP/ENVIRONMENT'>\n        <method_credential user='RUNASTHISUSER' group='RUNASTHISGROUP' />\n        <method_environment>\n          <envvar name=\"PATH\" value=\"/PATH/TO/JRUBY/bin:/usr/bin:/bin\" />\n        </method_environment>\n      </method_context>\n    </instance>\n  </service>\n</service_bundle>\n</pre>\n\n===Import the Manifest Into SMF===\n $ pfexec svccfg validate config/glassfish-gem.smf.xml\n $ pfexec svccfg import config/glassfish-gem.smf.xml\n\n===Start Your Appserver===\n $ pfexec svcadm enable glassfish-gem:my-railsapp_production\n\nTo verify that your application started, use <tt>svcs</tt>.\n $ pfexec svcs\n\nYou should see something like:\n online   Jun_30  svc:/network/glassfish-gem:my-railsapp_production\n\nIf it fails to start, it will say <tt>offline</tt> or <tt>maintenance</tt> instead of <tt>online</tt>. In that case, try <tt>svcs</tt> <tt>-xv</tt> and look at the logfile.\n\n===Stop Your Appserver===\n $ pfexec svcadm disable glassfish-gem:my-railsapp_production\n\n===Restart Your Appserver===\n $ pfexec svcadm restart glassfish-gem:my-railsapp_production\n\n==Apache 2.2 Frontend== \nOn OpenSolaris you can install Apache 2.2 with IPS:\n # pkg install SUNWapch22\n\nOn Ubuntu/Debian Linux, you would use apt: (''TODO: verify package name on Ubuntu/Debian.'')\n  # aptitude install apache2.2\n\nThis example's commands also refer to Solaris. You configure Apache 2.2. the same way in other operating systems, but paths to configurations might vary. For instance on Debian/Ubuntu, Apache config files are placed in<br/><tt>/etc/apache2/sites-available/MY-CONFIG-FILE</tt>, and these are enabled by a symlink in<br/><tt>/etc/apache2/sites-enabled</tt> to the config file.\n\nFile <tt>/etc/apache2/2.2/sites/myrailsapp.jruby.org</tt>\n\n<pre name=\"xml\">\n<VirtualHost *:80>\n  ServerName myrailsapp.jruby.org\n  DocumentRoot /var/apps/my-railsapp/production/my-railsapp/public\n\n  <Directory /var/apps/my-railsapp/production/my-railsapp/public>\n    Options FollowSymLinks\n    AllowOverride All\n    Order allow,deny\n    Allow from all\n  </Directory>\n\n  <Proxy balancer://myrailsapp>\n    BalancerMember http://127.0.0.1:3000\n  </Proxy>\n\n  ProxyPass / balancer://myrailsapp/\n  CustomLog /var/log/apache2/myrailsapp_production_apache_access_log combined\n</VirtualHost>\n</pre>\nSince I place my virtual hosts in separate files, I need to add <tt>include</tt> to these at the bottom of the main configuration file <tt>/etc/apache2/2.2/httpd.conf</tt>. If you haven't already configured your Apache server to use Virtual Hosts, you might have to add <tt>NameVirtualHost</tt> to your configuration:\n NameVirtualHost *:80\n Include /etc/apache2/2.2/sites/*\n\nNow just enable (or restart) your Apache 2.2 server: \n $ pfexec svcadm enable apache22 \n $ pfexec svcadm restart apache22\n\n'''TODO''': ''Nginx frontend, Linux init.rd start/stop script. Formatting.''","created_at":"2009-07-03T00:48:13Z","content_type":"application/vnd.com.kenai.page.revision+json"}