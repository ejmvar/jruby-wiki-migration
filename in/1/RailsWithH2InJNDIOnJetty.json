{"href":"https://kenai.com/api/projects/jruby/features/wiki/pages/RailsWithH2InJNDIOnJetty/revisions/1.json","name":"RailsWithH2InJNDIOnJetty","number":1,"page_href":"https://kenai.com/api/projects/jruby/features/wiki/pages/RailsWithH2InJNDIOnJetty.json","person":"john_brock","description":"","text":"In order to have an H2 database in a file be accessible from a web server it in necessary to configure the webserver for JNDI.  Here we use warbler to create a war from an existing rails app and deploy it on Jetty.\r\n\r\n1. Install h2 adapter and warbler\r\n\r\n  # jruby -S gem install activerecord-jdbch2-adapter warbler -v 0.9.5\r\n\r\nThese instructions don't appear to work with warbler 0.9.9.\r\n\r\n2. Create production database and run migrations\r\n\r\nI'm not sure what the most elegant way to do this is.  One way is to edit the database.yml file before creating the database to make it easy to create the database and then modify it again before creating the .war file.  In my case, I simply set the name of the development database to the name of the production database.\r\nTo do so, edit database.yml as follows:\r\n<pre>\r\ndevelopment:\r\n  adapter: jdbch2\r\n  database: c:/db/my_database_name\r\n  username: my_username\r\n  password: my_password\r\n\r\n...\r\n\r\nproduction:\r\n  adapter: jdbch2\r\n  jndi: java:comp/env/my_db\r\n  username: my_username\r\n  password: my_password\r\n\r\n</pre>\r\n\r\nRun\r\n\r\n  #  jruby -S rake db:migrate\r\n\r\n3. Create and edit warble.rb\r\n\r\nRun\r\n\r\n  # jruby -S warble config\r\n\r\nThis will create a config/warble.rb file.\r\nAt about line 36 of this file add\r\n  \r\n  # config.gems << \"activerecord-jdbch2-adapter\"\r\n\r\nand be sure that the line.\r\n  \r\n  # config.gem_dependencies = true\r\n\r\nis not commented out.\r\n\r\nNear the bottom of the file uncomment and edit the line with config.webxml.jndi\r\n\r\n  # config.webxml.jndi = \"my_db\"\r\n\r\nNote: I had better luck with this when the value did not include a slash.  \"rails/db\" for example didn't work.\r\n\r\n4.  Create war file.\r\n\r\nRun\r\n\r\n  #  jruby -S warble war\r\n\r\n5.  Configure Jetty\r\n\r\nUnzip your Jetty download to JETTY_HOME.  Copy GEM_HOME/jdbc-h2-1.0.63/lib/h2-1.0.63.jar to JETTY_HOME/lib. In order to enable JNDI, the jetty-plus configuration has to be set up.  One way to do this is to uncomment lines 57-71 in JETTY_HOME/etc/jetty-plus.xml.  Another way would be to create another configuration file following JETTY_HOME/etc/jetty.xml and adding the configuration classes in JETTY_HOME/etc/jetty.xml.  If you go the route of uncommenting the lines in jetty-plus.xml, you will need to create a directory JETTY_HOME/webapps-plus and put your war file there.\r\n\r\nYou will also need to add the jndi data source, for example by adding a file called my_jetty.xml.\r\n\r\n<pre>\r\n<?xml version=\"1.0\"?>\r\n<!DOCTYPE Configure PUBLIC \"-//Mort Bay Consulting//DTD Configure//EN\" \"http://jetty.mortbay.org/configure.dtd\">\r\n\r\n<Configure id=\"Server\" class=\"org.mortbay.jetty.Server\">\r\n\r\n  <New id=\"MyDb\" class=\"org.mortbay.jetty.plus.naming.Resource\">\r\n    <Arg>my_db</Arg>\r\n    <Arg>\r\n      <New class=\"org.h2.jdbcx.JdbcDataSource\">\r\n        <Set name=\"URL\">jdbc:h2:file:c:/db/my_database_name</Set>\r\n\t<Set name=\"User\">my_username</Set>\r\n        <Set name=\"Password\">my_password</Set>\r\n      </New>\r\n    </Arg>\r\n  </New>\r\n\r\n</Configure>\r\n</pre>\r\n\r\n6. Run the Jetty web server\r\n\r\nIn the scenario described in step 5 this would be.\r\n\r\n  #  JETTY_HOME> java -jar start.jar etc/jetty.xml etc/jetty-plus.xml my_jetty.xml\r\n\r\nThis will start the application at localhost:8080/my_app_name:\r\n\r\nClearly, \"my_app_name\", \"my_username\", \"my_password\", \"c:/db/my_database_name\" and \"my_db\" should be replaced throughout with the appropriate values.\r\n","created_at":"2008-08-12T20:39:26Z","content_type":"application/vnd.com.kenai.page.revision+json"}